{"version":3,"sources":["../../src/methods/remove.ts"],"sourcesContent":["import { runMultipleHook, runSingleHook } from '../components/hooks.js'\nimport { trackRemoval } from '../components/sync-blocking-checker.js'\nimport { Orama } from '../types.js'\n\nexport async function remove(orama: Orama, id: string, language?: string, skipHooks?: boolean): Promise<boolean> {\n  let result = true\n  const { index, docs } = orama.data\n\n  const doc = await orama.documentsStore.get(docs, id)\n  if (!doc) {\n    return false\n  }\n\n  const docsCount = await orama.documentsStore.count(docs)\n\n  if (!skipHooks) {\n    await runSingleHook(orama.beforeRemove, orama, id)\n  }\n\n  const indexableProperties = await orama.index.getSearchableProperties(index)\n  const indexablePropertiesWithTypes = await orama.index.getSearchablePropertiesWithTypes(index)\n  const values = await orama.getDocumentProperties(doc, indexableProperties)\n\n  for (const prop of indexableProperties) {\n    const value = values[prop]\n    // The document doens't contain the key\n    if (typeof value === 'undefined') {\n      continue\n    }\n\n    const schemaType = indexablePropertiesWithTypes[prop]\n\n    await orama.index.beforeRemove?.(\n      orama.data.index,\n      prop,\n      id,\n      value,\n      schemaType,\n      language,\n      orama.tokenizer,\n      docsCount,\n    )\n    if (\n      !(await orama.index.remove(\n        orama.index,\n        orama.data.index,\n        prop,\n        id,\n        value,\n        schemaType,\n        language,\n        orama.tokenizer,\n        docsCount,\n      ))\n    ) {\n      result = false\n    }\n    await orama.index.afterRemove?.(orama.data.index, prop, id, value, schemaType, language, orama.tokenizer, docsCount)\n  }\n\n  const sortableProperties = await orama.sorter.getSortableProperties(orama.data.sorting)\n  const sortableValues = await orama.getDocumentProperties(doc, sortableProperties)\n  for (const prop of sortableProperties) {\n    // The document doens't contain the key\n    if (typeof sortableValues[prop] === 'undefined') {\n      continue\n    }\n\n    await orama.sorter.remove(orama.data.sorting, prop, id)\n  }\n\n  if (!skipHooks) {\n    await runSingleHook(orama.afterRemove, orama, id)\n  }\n\n  await orama.documentsStore.remove(orama.data.docs, id)\n\n  trackRemoval(orama)\n  return result\n}\n\nexport async function removeMultiple(\n  orama: Orama,\n  ids: string[],\n  batchSize?: number,\n  language?: string,\n  skipHooks?: boolean,\n): Promise<number> {\n  let result = 0\n\n  if (!batchSize) {\n    batchSize = 1000\n  }\n\n  if (!skipHooks) {\n    await runMultipleHook(orama.beforeMultipleRemove, orama, ids)\n  }\n\n  await new Promise<void>((resolve, reject) => {\n    let i = 0\n    async function _insertMultiple() {\n      const batch = ids.slice(i * batchSize!, (i + 1) * batchSize!)\n      i++\n\n      if (!batch.length) {\n        return resolve()\n      }\n\n      for (const doc of batch) {\n        try {\n          if (await remove(orama, doc, language, skipHooks)) {\n            result++\n          }\n        } catch (err) {\n          reject(err)\n        }\n      }\n\n      setTimeout(_insertMultiple, 0)\n    }\n\n    setTimeout(_insertMultiple, 0)\n  })\n\n  if (!skipHooks) {\n    await runMultipleHook(orama.afterMultipleRemove, orama, ids)\n  }\n\n  return result\n}\n"],"names":["runMultipleHook","runSingleHook","trackRemoval","remove","orama","id","language","skipHooks","result","index","docs","data","doc","documentsStore","get","docsCount","count","beforeRemove","indexableProperties","getSearchableProperties","indexablePropertiesWithTypes","getSearchablePropertiesWithTypes","values","getDocumentProperties","prop","value","schemaType","tokenizer","afterRemove","sortableProperties","sorter","getSortableProperties","sorting","sortableValues","removeMultiple","ids","batchSize","beforeMultipleRemove","Promise","resolve","reject","i","_insertMultiple","batch","slice","length","err","setTimeout","afterMultipleRemove"],"mappings":"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"}