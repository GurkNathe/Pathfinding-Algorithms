{"version":3,"sources":["../../src/components/sorter.ts"],"sourcesContent":["import { createError } from '../errors.js'\nimport { ISorter, OpaqueSorter, Orama, Schema, SorterConfig, SorterParams, SortType, SortValue } from '../types.js'\n\ninterface PropertySort<K> {\n  docs: Record<string, number>\n  orderedDocs: [string, K][]\n  type: SortType\n}\n\nexport interface Sorter extends OpaqueSorter {\n  enabled: boolean\n  sortableProperties: string[]\n  sortablePropertiesWithTypes: Record<string, SortType>\n  sorts: Record<string, PropertySort<number | string | boolean>>\n}\n\nexport type DefaultSorter = ISorter<Sorter>\n\nfunction innerCreate(schema: Schema, sortableDeniedProperties: string[], prefix: string): Sorter {\n  const sorter: Sorter = {\n    enabled: true,\n    sortableProperties: [],\n    sortablePropertiesWithTypes: {},\n    sorts: {},\n  }\n\n  for (const [prop, type] of Object.entries(schema)) {\n    const typeActualType = typeof type\n    const path = `${prefix}${prefix ? '.' : ''}${prop}`\n\n    if (sortableDeniedProperties.includes(path)) {\n      continue\n    }\n\n    if (typeActualType === 'object' && !Array.isArray(type)) {\n      // Nested\n      const ret = innerCreate(type as Schema, sortableDeniedProperties, path)\n      sorter.sortableProperties.push(...ret.sortableProperties)\n      sorter.sorts = {\n        ...sorter.sorts,\n        ...ret.sorts,\n      }\n      sorter.sortablePropertiesWithTypes = {\n        ...sorter.sortablePropertiesWithTypes,\n        ...ret.sortablePropertiesWithTypes,\n      }\n      continue\n    }\n\n    switch (type) {\n      case 'boolean':\n      case 'number':\n      case 'string':\n        sorter.sortableProperties.push(path)\n        sorter.sortablePropertiesWithTypes[path] = type\n        sorter.sorts[path] = {\n          docs: {},\n          orderedDocs: [],\n          type: type,\n        }\n        break\n      case 'boolean[]':\n      case 'number[]':\n      case 'string[]':\n        // We don't allow to sort by arrays\n        continue\n      default:\n        throw createError('INVALID_SORT_SCHEMA_TYPE', Array.isArray(type) ? 'array' : (type as unknown as string), path)\n    }\n  }\n\n  return sorter\n}\n\nasync function create(_: Orama, schema: Schema, config?: SorterConfig): Promise<Sorter> {\n  const isSortEnabled = config?.enabled !== false\n  if (!isSortEnabled) {\n    return {\n      disabled: true,\n    } as unknown as Sorter\n  }\n  return innerCreate(schema, (config || {}).unsortableProperties || [], '')\n}\n\nfunction stringSort(value: SortValue, language: string | undefined, d: [string, SortValue]): boolean {\n  return (d[1] as string).localeCompare(value as string, language) > 0\n}\nfunction numerSort(value: SortValue, d: [string, SortValue]): boolean {\n  return (d[1] as number) > (value as number)\n}\nfunction booleanSort(value: SortValue, d: [string, SortValue]): boolean {\n  return d[1] as boolean\n}\n\nasync function insert(\n  sorter: Sorter,\n  prop: string,\n  id: string,\n  value: SortValue,\n  schemaType: SortType,\n  language: string | undefined,\n): Promise<void> {\n  if (!sorter.enabled) {\n    return\n  }\n  const s = sorter.sorts[prop]\n\n  let predicate: (value: [string, SortValue]) => boolean\n  switch (schemaType) {\n    case 'string':\n      predicate = stringSort.bind(null, value, language)\n      break\n    case 'number':\n      predicate = numerSort.bind(null, value)\n      break\n    case 'boolean':\n      predicate = booleanSort.bind(null, value)\n      break\n  }\n\n  // Find the right position to insert the element\n  let index = s.orderedDocs.findIndex(predicate)\n  if (index === -1) {\n    index = s.orderedDocs.length\n    s.orderedDocs.push([id, value])\n  } else {\n    s.orderedDocs.splice(index, 0, [id, value])\n  }\n  s.docs[id] = index\n\n  // Increment position for the greather documents\n  const orderedDocsLength = s.orderedDocs.length\n  for (let i = index + 1; i < orderedDocsLength; i++) {\n    const docId = s.orderedDocs[i][0]\n    s.docs[docId]++\n  }\n}\n\nasync function remove(sorter: Sorter, prop: string, id: string) {\n  if (!sorter.enabled) {\n    return\n  }\n  const s = sorter.sorts[prop] as PropertySort<SortValue>\n\n  const index = s.docs[id]\n  delete s.docs[id]\n\n  // Decrement position for the greather documents\n  const orderedDocsLength = s.orderedDocs.length\n  for (let i = index + 1; i < orderedDocsLength; i++) {\n    const docId = s.orderedDocs[i][0]\n    s.docs[docId]--\n  }\n\n  s.orderedDocs.splice(index, 1)\n}\n\nasync function sortBy(sorter: Sorter, docIds: [string, number][], by: SorterParams): Promise<[string, number][]> {\n  if (!sorter.enabled) {\n    throw createError('SORT_DISABLED')\n  }\n\n  const property = by.property\n  const isDesc = by.order === 'DESC'\n\n  const s = sorter.sorts[property]\n  if (!s) {\n    throw createError('UNABLE_TO_SORT_ON_UNKNOWN_FIELD', property, sorter.sortableProperties.join(', '))\n  }\n\n  docIds.sort((a, b) => {\n    // This sort algorithm works leveraging on\n    // that s.docs is a map of docId -> position\n    // If a document is not indexed, it will be not present in the map\n    const indexOfA = s.docs[a[0]]\n    const indexOfB = s.docs[b[0]]\n    const isAIndexed = typeof indexOfA !== 'undefined'\n    const isBIndexed = typeof indexOfB !== 'undefined'\n\n    if (!isAIndexed && !isBIndexed) {\n      return 0\n    }\n    // unindexed documents are always at the end\n    if (!isAIndexed) {\n      return 1\n    }\n    if (!isBIndexed) {\n      return -1\n    }\n\n    return isDesc ? indexOfB - indexOfA : indexOfA - indexOfB\n  })\n\n  return docIds\n}\n\nasync function getSortableProperties(sorter: Sorter): Promise<string[]> {\n  if (!sorter.enabled) {\n    return []\n  }\n\n  return sorter.sortableProperties\n}\n\nasync function getSortablePropertiesWithTypes(sorter: Sorter): Promise<Record<string, SortType>> {\n  if (!sorter.enabled) {\n    return {}\n  }\n\n  return sorter.sortablePropertiesWithTypes\n}\n\nexport async function load<R = unknown>(raw: R): Promise<Sorter> {\n  const rawDocument = raw as Sorter\n  if (!rawDocument.enabled) {\n    return {\n      enabled: false,\n    } as unknown as Sorter\n  }\n\n  return {\n    sortableProperties: rawDocument.sortableProperties,\n    sortablePropertiesWithTypes: rawDocument.sortablePropertiesWithTypes,\n    sorts: rawDocument.sorts,\n    enabled: true,\n  }\n}\n\nexport async function save<R = unknown>(sorter: Sorter): Promise<R> {\n  if (!sorter.enabled) {\n    return {\n      enabled: false,\n    } as unknown as R\n  }\n\n  return {\n    sortableProperties: sorter.sortableProperties,\n    sortablePropertiesWithTypes: sorter.sortablePropertiesWithTypes,\n    sorts: sorter.sorts,\n    enabled: sorter.enabled,\n  } as R\n}\n\nexport async function createSorter(): Promise<DefaultSorter> {\n  return {\n    create,\n    insert,\n    remove,\n    save,\n    load,\n    sortBy,\n    getSortableProperties,\n    getSortablePropertiesWithTypes,\n  }\n}\n"],"names":["createError","innerCreate","schema","sortableDeniedProperties","prefix","sorter","enabled","sortableProperties","sortablePropertiesWithTypes","sorts","prop","type","Object","entries","typeActualType","path","includes","Array","isArray","ret","push","docs","orderedDocs","create","_","config","isSortEnabled","disabled","unsortableProperties","stringSort","value","language","d","localeCompare","numerSort","booleanSort","insert","id","schemaType","s","predicate","bind","index","findIndex","length","splice","orderedDocsLength","i","docId","remove","sortBy","docIds","by","property","isDesc","order","join","sort","a","b","indexOfA","indexOfB","isAIndexed","isBIndexed","getSortableProperties","getSortablePropertiesWithTypes","load","raw","rawDocument","save","createSorter"],"mappings":"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"}